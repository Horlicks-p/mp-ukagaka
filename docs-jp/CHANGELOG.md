# MP Ukagaka バージョン履歴

> 📋 全バージョンの更新記録

---

## [2.2.0] - 2025-12-19

### 🚀 メジャーアップデート：汎用 LLM インターフェース

- **複数 AI プロバイダーサポート**：統一インターフェースで 4 つの AI サービスをサポート
  - **Ollama**：ローカル/リモート無料 LLM（API Key 不要）
  - **Google Gemini**：Gemini 2.5 Flash（推奨）、Gemini 1.5 Pro などをサポート
  - **OpenAI**：GPT-4.1 Mini（推奨）、GPT-4o などをサポート
  - **Claude (Anthropic)**：Claude Sonnet 4.5、Claude Haiku 4.5、Claude Opus 4.5 をサポート
  - すべてのプロバイダーで統一された設定インターフェースを使用、いつでも切り替え可能

- **API Key 暗号化保存**：すべての API Key を自動暗号化して保存、セキュリティを確保
- **接続テスト機能**：すべての AI プロバイダーに接続テストボタンを追加

### 🧠 System Prompt 最適化システム

- **XML 構造化設計**：XML タグで System Prompt を整理、LLM の理解効率を向上
  - `<character>`：キャラクター名とコア設定
  - `<knowledge_base>`：圧縮された WordPress 情報
  - `<behavior_rules>`：行動ルール（must_do、should_do、must_not_do）
  - `<response_style_examples>`：70+ の会話例
  - `<current_context>`：現在のコンテキスト情報

- **コンテキスト圧縮機構**：WordPress、ユーザー、訪問者情報を自動圧縮、トークン使用量を削減
- **フリーレン風範例システム**：70+ の実際の会話例を内蔵、12 カテゴリをカバー
  - 挨拶類、雑談類、時間感知類、観察思考類
  - 魔法研究類、技術観察類、統計観察類、回想類
  - 管理者評語類、意外反応類、BOT 検出類、沈黙類

- **二層アーキテクチャ設計**：
  - **System Prompt**：キャラクターの風格、行動ルール、会話例を定義
  - **User Prompt**：各会話の具体的なタスク指示（範例カテゴリに対応）

### 🎨 UI/UX 全面アップグレード

- **統一カードデザイン**：すべての設定ページで一貫したカードレイアウトを採用
- **アニメ風配色**：フリーレン公式サイトデザインを参考に、柔らかいグラデーション背景
  - カード背景：`#E8F4F8`（淡いブルーグリーン）
  - ボーダー色：`#B8E6E6`（薄いシアン）
  - タイトル色：`#4A9EBD`（ブルーグリーン）
  - テキスト色：`#2C3E50`（ダークブルーグレー）

- **2 カラムレイアウト**：メイン設定ページでメインコンテンツ + サイドバー設計
  - メインコンテンツ幅：55%
  - サイドバー幅：300px（固定）
  - サイドバー内容：AI Provider リンク、ドキュメントリンク、一般リンク

- **カスタムスクロールバースタイル**：長いテキストエリア（System Prompt など）に美しいスクロールバーを追加

### 🔧 機能改善

- **ページ認識機能統合**：「ページ認識機能」設定を LLM 設定ページに移動
  - すべての LLM 関連設定を統一管理
  - 「LLM で内蔵ダイアログを置換」機能と統合

- **AI 設定ページ簡素化**：「ページ感知」機能に集中
  - 保持：言語設定、キャラクター設定、ページ感知確率、トリガーページ、AI 会話の表示時間、初回訪問者への挨拶
  - 移動：AI プロバイダー選択、API Key 設定、モデル選択（LLM 設定ページへ）

- **統計比喩の最適化**：ゲーミフィケーション統計比喩を復元・最適化
  - 魔族遭遇回数 = 記事数 (`post_count`)
  - 最大ダメージ = コメント数 (`comment_count`)
  - 習得スキル総数 = カテゴリ数 (`category_count`)
  - アイテム使用回数 = タグ数 (`tag_count`)
  - 冒険経過日数 = 運営日数 (`days_operating`)

### 📝 コード最適化

- **新関数**：
  - `mpu_build_optimized_system_prompt()`：System Prompt を構築（変数置換サポート）
  - `mpu_build_prompt_categories()`：User Prompt 指示カテゴリを生成
  - `mpu_compress_context_info()`：コンテキスト情報を圧縮
  - `mpu_get_visitor_status_text()`：訪問者ステータステキストを取得

- **関数リファクタリング**：
  - `mpu_generate_llm_dialogue()`：新しい最適化 System Prompt システムを使用
  - 古い冗長な System Prompt 構築ロジックを削除

- **下位互換性**：古い設定のサポートを維持、設定キーを自動移行

### 🐛 バグ修正

- 統計比喩の対応関係を修正
- テキストエリア幅設定を最適化（統一 850px）
- メインメニュー下部線の配置問題を修正
- スクロールバースタイル問題を修正

### 📚 ドキュメント更新

- `USER_GUIDE.md` を更新：汎用 LLM インターフェースと System Prompt 最適化システムを完全説明
- `CHANGELOG.md` を更新：2.2.0 バージョンのすべての更新を記録

### 🎉 特別更新（2025-12-19）

- 『葬送のフリーレン』第 2 期が 2026 年 1 月 16 日に放送開始することを記念して、デフォルトキャラクターを初音からフリーレンに変更
- 新規インストールユーザーはフリーレンがデフォルトキャラクターとして表示
- 既存ユーザーでデフォルトキャラクター名が「初音」のままの場合、システムが自動的にフリーレンに更新

---

## [2.1.7] - 2025-12-15

### 🚀 パフォーマンス最適化

- **JavaScript ファイル構造リファクタリング**：10 個の JS ファイルを 4 つに統合、HTTP リクエストを削減
  - `ukagaka-base.js`：config + utils + ajax を統合（基盤層）
  - `ukagaka-core.js`：ui + dialogue + core を統合（コア機能）
  - `ukagaka-features.js`：ai + external + events を統合（機能モジュール）
  - `ukagaka-anime.js`：独立維持（アニメーションモジュール）
  - すべてのファイルで `ukagaka-` プレフィックス命名を統一

- **mousemove ログ最適化**：頻繁にトリガーされるログ記録を削除、コンソールの洪水を回避
  - `mousemove` イベントのログ出力をコメントアウト
  - デバッグモードでのデバッグ体験を向上

### 🔧 機能改善

- **LLM リクエスト最適化**：POST 方式でデータを送信、URL 長さ制限を回避
  - `FormData` ですべてのパラメータを送信（`cur_num`、`cur_msgnum`、`last_response`、`response_history`）
  - バックエンドで POST と GET 両方をサポート（下位互換性）
  - `wp_unslash()` で WordPress の JSON データを正しく処理

- **LLM リクエスト連打防止**：`cancelPrevious: true` オプションを追加
  - ユーザーが「次へ」を素早く連続クリックした時、前の未完了リクエストを自動キャンセル
  - 複数の並行リクエストがタイプライター効果を上書きするのを回避

### 🐛 エラー処理最適化

- **Canvas アニメーションエラー処理**：`mpuChange` 関数の開始時に Canvas Manager をチェック
  - `window.mpuCanvasManager` が存在するかを事前チェック
  - Ajax 成功後にエラーを発見することを避け、より一貫した体験を提供

- **LLM エラービジュアル提示**：デバッグモードでエラーメッセージを表示
  - 表示形式：`[LLM エラー: エラーメッセージ]`
  - 2 秒後に自動的にフォールバックダイアログに切り替え
  - 非デバッグモードでは直接フォールバックダイアログを使用、一般ユーザーに影響なし

### 📝 その他の改善

- ファイル命名規則を統一：すべての JavaScript ファイルで `ukagaka-` プレフィックスを使用
  - `jquery.textarearesizer.compressed.js` → `ukagaka-textarearesizer.js`

---

## [2.1.6] - 2025-12-13

### ✨ 新機能

- **WordPress 情報統合**：LLM 自発ダイアログがサイト情報を取得してコメント可能に
  - WordPress バージョン、テーマ情報（名前、バージョン、作者）、PHP バージョン、サイト名を統合
  - 統計情報：記事数、コメント数、カテゴリ数、タグ数、運営日数
  - transient キャッシュ機構を使用（5 分間）、パフォーマンス向上
  - `wordpress_info` と `statistics` の 2 つのプロンプトカテゴリを追加

- **RPG 風統計情報**：統計情報にゲーミフィケーション用語を使用
  - 魔族遭遇回数（記事数）
  - 最大ダメージ（コメント数）
  - 習得スキル総数（カテゴリ数）
  - アイテム使用回数（タグ数）
  - 冒険日数（運営日数）

- **重複ダイアログ防止機構**：「無駄話ループ」問題を回避
  - 前回の LLM 生成応答を追跡
  - プロンプトに重複回避指示を追加
  - 自動的に異なる雑談内容を生成するか、沈黙を維持

- **アイドル検出機能**：リソース節約のため自動ダイアログを自動一時停止
  - ユーザーアクティビティを検出（マウス、キーボード、スクロール、クリック）
  - 60 秒のアイドル閾値（調整可能）
  - ユーザーが戻った時に自動復帰
  - GPU とネットワークリソースを効果的に節約

### 🔧 改善

- **LLM システムプロンプト強化**：WordPress サイト情報を背景知識として追加
- **プロンプトの多様性向上**：WordPress 関連と統計情報関連のプロンプトを追加
- **パフォーマンス最適化**：不要な LLM リクエストを削減
- **リソース管理**：GPU とネットワークリソースの使用制御を改善

### 📝 技術詳細

- `mpu_get_wordpress_info()` 関数を追加（`includes/utility-functions.php` 内）
- `mpu_generate_llm_dialogue()` 関数を変更、WordPress 情報を統合
- フロントエンド JavaScript にアイドル検出ロジックを追加（`ukagaka-core.js`）
- AJAX ハンドラで `last_response` パラメータをサポート

---

## [2.1.0] - 2025-11-26

### ✨ 新機能

- **設定可能なタイプ速度**：タイプライター効果速度設定を追加（10-200 ミリ秒/文字）
- **API Key 暗号化保存**：AES-256-CBC ですべての API Key を暗号化
- **安全なファイル操作**：WordPress Filesystem API ですべてのファイル読み書きを実行
- **ディレクトリトラバーサル保護**：すべてのファイルパスを検証、不正アクセスを防止

### 🔧 改善

- 設定済み API Key に緑のチェックマークインジケーターを表示
- ファイル操作のエラーメッセージを改善
- 下位互換性：既存の平文 API Key を自動暗号化

### 🔒 セキュリティ

- すべての API Key で AES-256-CBC 暗号化を使用
- ファイル操作で WordPress Filesystem API を使用
- ディレクトリトラバーサル攻撃を防ぐパス検証を追加

---

## [2.0.0] - 2025-11-22

### 🏗️ アーキテクチャ改善

- **完全モジュール化リファクタリング**：単一ファイルを 7 つの独立モジュールに分割
- **メインプログラム簡素化**：`mp-ukagaka.php` を約 85 行に簡素化
- **依存順序読み込み**：モジュールを依存関係順に読み込み

### ✨ 新機能

- **AI ページ感知**：記事内容に基づいて AI コメントを自動生成
- **複数 AI プロバイダーサポート**：
  - Google Gemini（gemini-2.5-flash、gemini-2.5-pro）
  - OpenAI GPT（GPT-4o、GPT-4o-mini、GPT-3.5-turbo）
  - Anthropic Claude（Claude Sonnet 4.5）
- **初回訪問者への挨拶**：新規訪問者にパーソナライズされた歓迎メッセージを表示
- **Slimstat 統合**：訪問者のソース、地域などの情報を取得
- **AI テキスト色**：AI 応答のテキスト色をカスタマイズ可能
- **AI 表示時間制御**：AI メッセージの表示時間を設定

### 🔧 改善

- **JSON ダイアログファイルサポート**：TXT に加えて JSON 形式をサポート
- **エラー処理の改善**：より詳細なエラーログ
- **パフォーマンス最適化**：設定読み取りにキャッシュ機構を使用

### 📁 モジュール構造

```
includes/
├── core-functions.php      # コア機能
├── utility-functions.php   # ユーティリティ関数
├── ai-functions.php        # AI 機能
├── ukagaka-functions.php   # 伺か管理
├── ajax-handlers.php       # AJAX 処理
├── frontend-functions.php  # フロントエンド機能
└── admin-functions.php     # 管理画面機能
```

---

## [1.9.x] - 過去バージョン

### 1.9.5

- 一部のテーマとの互換性問題を修正
- ダイアログ表示効果を改善

### 1.9.4

- 自動ダイアログ機能を追加
- ダイアログ間隔時間設定を追加

### 1.9.3

- 外部ダイアログファイルサポートを追加（TXT 形式）
- 複数伺か切り替え機能を追加

### 1.9.2

- ページ除外機能を追加
- モバイルデバイス表示を改善

### 1.9.1

- 固定メッセージ機能を追加
- 共通会話機能を追加

### 1.9.0

- クリック動作設定を追加
- 会話順序設定を追加

---

## [1.8.x] - 過去バージョン

### 1.8.5

- jQuery 互換性修正を追加
- WordPress 5.x 互換性を改善

### 1.8.0

- 多言語サポートを追加
- 繁体字中国語、日本語翻訳を追加

---

## [1.7.x] - 過去バージョン

### 1.7.0

- 伺か管理インターフェースを追加
- 新しい伺か作成機能を追加

---

## [1.6.x] - 過去バージョン

### 1.6.0

- 拡張ページを追加
- カスタム JavaScript 機能を追加

---

## [1.5.x] - 過去バージョン

### 1.5.0

- 初期公開バージョン
- 基本伺か表示機能
- 基本ダイアログ機能

---

## アップグレードガイド

### 1.x から 2.x へのアップグレード

1. **設定をバックアップ**
   - `wp_options` の `mpu_opt` オプションをバックアップすることを推奨

2. **プラグインをアップグレード**
   - 新バージョンを旧バージョンに上書きアップロード
   - または WordPress 管理画面から更新

3. **設定を確認**
   - アップグレード後、設定は自動的に保持
   - すべての設定ページを確認することを推奨

4. **キャッシュをクリア**
   - ブラウザキャッシュをクリア
   - WordPress キャッシュプラグインのキャッシュをクリア

### 2.0.x から 2.1.x へのアップグレード

1. **API Key 自動暗号化**
   - 既存の平文 API Key は最初の設定保存時に自動暗号化
   - 手動操作は不要

2. **ファイル権限を確認**
   - `dialogs/` フォルダが書き込み可能であることを確認
   - WordPress Filesystem API には適切な権限が必要

### 2.1.x から 2.2.0 へのアップグレード

1. **設定自動移行**
   - すべての既存設定は自動的に保持・移行
   - AI プロバイダー設定は LLM 設定ページに自動移行
   - 手動操作は不要

2. **LLM 設定を確認**
   - **設定** → **MP Ukagaka** → **LLM 設定** に移動
   - AI プロバイダー選択が正しいことを確認
   - API Key が正しく設定されていることを確認（自動暗号化）
   - 接続テストで正常動作を確認

3. **AI 設定を確認**
   - **設定** → **MP Ukagaka** → **AI 設定** に移動
   - 「ページ感知確率」と「トリガーページ」設定が正しいことを確認
   - 「キャラクター設定（System Prompt）」内容が正しいことを確認

4. **キャッシュをクリア**
   - ブラウザキャッシュをクリア
   - WordPress キャッシュプラグインのキャッシュをクリア（使用している場合）

5. **新しい UI を体験**
   - すべての設定ページが新しいカードデザインに更新
   - メイン設定ページにサイドバークイックリンクを追加

---

## 既知の問題

### 2.1.0

- 一部の古い PHP（< 7.4）では暗号化機能がサポートされない可能性
- PHP 7.4 以上へのアップグレードを推奨

### 2.0.0

- AI 機能には安定したネットワーク接続が必要
- 一部のファイアウォールが AI API リクエストをブロックする可能性

---

## 問題報告

問題を発見した場合、以下の情報を提供してください：

1. WordPress バージョン
2. PHP バージョン
3. プラグインバージョン
4. エラーメッセージ（ある場合）
5. ブラウザコンソールエラー（F12 で確認）

---

## 貢献者

- **原作者**：Ariagle *(元サイトは運営終了)*
- **メンテナー**：Horlicks ([MoeLog](https://www.moelog.com/))

---

**すべてのユーザーのサポートとフィードバックに感謝！** ❤️
