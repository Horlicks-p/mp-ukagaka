# MP Ukagaka

WordPress サイトにインタラクティブな伺か（デスクトップマスコット）キャラクターを作成・表示するプラグイン。AI コンテキスト認識機能搭載。

[![プラグインバージョン](https://img.shields.io/badge/version-2.1.6-blue.svg)](https://github.com)
[![WordPress](https://img.shields.io/badge/WordPress-5.0%2B-blue.svg)](https://wordpress.org/)
[![PHP](https://img.shields.io/badge/PHP-7.4%2B-purple.svg)](https://www.php.net/)

🌍 **他の言語**: [English](README.md) | [繁體中文](README_zh-TW.md)

## 📸 スクリーンショット

![MP Ukagaka デモ](screenshot.PNG)

_フリーレンが記事内容に基づいて AI 生成のダイアログを表示_

## 📖 概要

MP Ukagaka は、WordPress サイトにカスタムのインタラクティブなデスクトップマスコットキャラクターを作成できるプラグインです。クラシックな MP Ukagaka プラグインをベースに、セキュリティ強化、パフォーマンス改善、モジュラーアーキテクチャ、最先端の AI 機能で完全に現代化されています。

### クラシック機能

- **複数キャラクター対応**：複数のゴーストキャラクターを作成・管理
- **カスタムダイアログ**：各キャラクター専用のメッセージを設計
- **外部ダイアログファイル**：TXT または JSON ファイルからダイアログを読み込み
- **自動会話**：設定可能な間隔で自動メッセージ切り替え
- **共通メッセージ**：全キャラクターに適用される共有メッセージ
- **ページ除外**：ゴーストを表示するページを制御
- **多言語対応**：繁体中国語、日本語、英語など複数言語をサポート

### 🚀 AI コンテキスト認識（v2.0.0 の新機能）

ページ内容を分析し、パーソナライズされた応答を生成するインテリジェントな AI 機能：

- **マルチプロバイダー AI サポート**：
  - **Google Gemini**：高速で効率的（gemini-2.5-flash、gemini-2.5-pro）
  - **OpenAI GPT**：強力な言語モデル（GPT-4o、GPT-4o-mini、GPT-3.5-turbo）
  - **Anthropic Claude**：高度な推論能力（Claude Sonnet 4.5）
- **スマートコンテンツ分析**：ページタイトルと内容を自動抽出・分析
- **設定可能なトリガー**：AI 会話を発動するページを設定
- **確率制御**：AI 応答頻度を調整（1-100%）して API コストを管理
- **カスタマイズ可能な性格**：システムプロンプトでキャラクターの個性を設計
- **ビジュアルカスタマイズ**：AI 会話のテキスト色をカスタマイズ
- **表示時間制御**：AI 会話が自動会話に上書きされるのを防止
- **多言語 AI**：繁体中国語、日本語、または英語で応答を生成
- **初回訪問者挨拶**：新規訪問者をパーソナライズされた AI 挨拶で歓迎（Slimstat プラグイン必要）

### 🧪 ローカル LLM サポート（ベータ版）

> ⚠️ **注意**：LLM 機能は現在**テスト段階（BETA）**にあります。機能が不安定な可能性があるため、ご注意ください。

プラグインは Ollama を介したローカル LLM 統合をサポートし、API コストなしでダイアログを生成できます：

- **Ollama 統合**：ローカルまたはリモートの Ollama インスタンスに接続
- **リモート接続サポート**：Cloudflare Tunnel、ngrok、その他のトンネルサービスと連携
- **組み込みダイアログの置き換え**：静的ダイアログを AI 生成コンテンツに置き換えるオプション
- **API Key 不要**：独自の LLM セットアップで完全無料
- **スマート接続検出**：ローカルとリモート接続のタイムアウト設定を自動調整
- **モデルサポート**：様々な Ollama モデル（Qwen3、Llama、Mistral など）と互換性
- **思考モード制御**：Qwen3 などのモデルの思考動作を無効化するオプション
- **WordPress 情報統合**：LLM ダイアログにサイト情報を含めることが可能（WordPress バージョン、テーマ情報、統計情報）
- **カスタマイズ可能な統計プロンプト**：RPG スタイルの用語をサポートする統計プロンプト（詳細は [USER_GUIDE.md](docs/USER_GUIDE.md) を参照）
- **反復防止メカニズム**：以前の応答を追跡し、繰り返しのアイドル会話を防止
- **アイドル検出機能**：ユーザーがアイドル状態（60 秒）のとき、自動会話を自動的に一時停止し、GPU とネットワークリソースを節約

**セットアップ要件：**

- ローカルまたはリモートサーバーに[Ollama](https://ollama.ai/)をインストール・実行
- 希望するモデルをダウンロード（例：`ollama pull qwen3:8b`）
- プラグイン設定でエンドポイント URL を設定（ローカル：`http://localhost:11434`またはリモート：`https://your-domain.com`）
- 詳細なセットアップ手順については、[USER_GUIDE.md](/docs/USER_GUIDE.md)を参照してください

**現在の制限事項：**

- 機能はテスト段階
- リモートセットアップで接続の問題が発生する可能性
- 応答時間はモデルと接続タイプによって異なる場合があります

## 📦 インストール

1. **プラグインをダウンロード**

   - このリポジトリからダウンロード
   - または WordPress プラグインディレクトリにクローン

2. **プラグインをインストール**

   ```bash
   # WordPressプラグインディレクトリに移動
   cd /path/to/wordpress/wp-content/plugins/

   # 解凍またはクローン
   unzip mp-ukagaka.zip
   ```

3. **プラグインを有効化**

   - WordPress 管理画面 → プラグインに移動
   - 「MP Ukagaka」を見つけて「有効化」をクリック

4. **設定**
   - **設定 → MP Ukagaka**に移動
   - 一般設定を構成し、最初のゴーストキャラクターを作成
   - （オプション）「AI 設定」セクションで AI 機能を有効化

## ⚙️ 設定

### 基本設定

1. **一般設定**

   - デフォルトゴーストキャラクターを選択
   - 表示の有効化/無効化
   - 自動会話間隔を設定
   - ページ除外ルールを設定

2. **キャラクター作成**

   - 「ゴースト」タブに移動
   - カスタム画像とダイアログで新しいキャラクターを追加
   - キャラクター固有の設定を構成

3. **ダイアログ設定**
   - **重要**：すべてのダイアログは外部ファイルとして保存する必要があります（TXT または JSON 形式）
   - ダイアログファイルを`dialogs/`フォルダに配置
   - キャラクター設定を保存すると自動的にダイアログファイルが生成されます
   - `dialogs/`フォルダで手動でダイアログファイルを作成/編集することもできます

### AI コンテキスト認識設定

1. **AI 機能を有効化**

   - 設定 → MP Ukagaka → AI 設定に移動
   - 「ページ認識機能を有効にする」をチェック

2. **AI プロバイダーを選択**

   **Google Gemini**（初心者におすすめ）：

   - [Google AI Studio](https://makersuite.google.com/app/apikey)から API Key を取得
   - プロバイダーとして「Gemini」を選択
   - API Key を入力
   - デフォルトモデル：gemini-2.5-flash

   **OpenAI GPT**：

   - [OpenAI Platform](https://platform.openai.com/api-keys)から API Key を取得
   - プロバイダーとして「OpenAI」を選択
   - API Key を入力
   - モデルを選択：gpt-4o-mini（推奨）、gpt-4o、または gpt-3.5-turbo

   **Anthropic Claude**：

   - [Anthropic Console](https://console.anthropic.com/)から API Key を取得
   - プロバイダーとして「Claude」を選択
   - API Key を入力
   - モデル：claude-sonnet-4-5-20250929

3. **AI 設定を構成**

   - **言語**：応答言語を選択（繁体中国語、日本語、英語）
   - **キャラクター設定**：キャラクターの個性を定義（例：「あなたは遊び心のあるデスクトップマスコットです。記事の内容を面白く、短く（40 字以内）コメントしてください。」）
   - **確率**：AI トリガー率を設定（1-100%、コスト管理には 10-30%推奨）
   - **トリガーページ**：AI をトリガーするページを指定（例：「is_single」で単一投稿のみ）
   - **テキスト色**：AI 会話のテキスト色をカスタマイズ
   - **表示時間**：AI メッセージの表示時間を設定（5-10 秒推奨）

4. **初回訪問者挨拶**（オプション）

   - 「初回訪問者への挨拶を有効化」を有効にする
   - 挨拶プロンプトを設定
   - 拡張訪問者追跡には Slimstat プラグインが必要

5. **設定を保存**
   - 「保存」ボタンをクリック
   - 単一投稿ページで AI 応答をテスト

### ローカル LLM (Ollama) 設定（ベータ版）

> ⚠️ **警告**：この機能は現在**テスト段階（BETA）**にあります。自己責任でご使用ください。

1. **Ollama をインストール**

   - ローカルマシンまたはサーバーに[Ollama](https://ollama.ai/)をダウンロード・インストール
   - Ollama サービスを起動
   - モデルをダウンロード：`ollama pull qwen3:8b`（または希望のモデル）

2. **プラグイン設定を構成**

   - 設定 → MP Ukagaka → LLM 設定に移動
   - 「LLM (Ollama) を有効化」をチェック
   - Ollama エンドポイントを入力：
     - **ローカル**：`http://localhost:11434`（デフォルト）
     - **リモート**：`https://your-domain.com`（Cloudflare Tunnel、ngrok など）
   - モデル名を入力（例：`qwen3:8b`、`llama3.2`、`mistral`）

3. **オプション設定**

   - **組み込みダイアログを置き換える**：静的ダイアログを LLM 生成ダイアログに置き換える
   - **思考モードを無効化**：Qwen3 モデルの応答速度向上に推奨
   - **接続をテスト**：「Ollama 接続をテスト」ボタンで設定を確認

4. **リモート接続（Cloudflare Tunnel）**
   - `http://localhost:11434`を指す Cloudflare Tunnel を設定
   - トンネル URL をエンドポイントとして使用（例：`https://your-domain.com`）
   - プラグインは自動的にリモート接続を検出し、タイムアウト設定を調整

## 🔧 高度な機能

### 外部ダイアログファイル

> ⚠️ **重要**：バージョン 2.1.3 以降、システムは**外部ダイアログファイルのみを使用**します。すべてのダイアログは外部ファイルとして`dialogs/`フォルダに保存する必要があります。内部ダイアログ保存機能は削除されました。

外部ファイルからダイアログを読み込むことができます（TXT または JSON 形式）：

**TXT 形式**（`dialogs/キャラクター名.txt`）：

```
メッセージ1

メッセージ2

メッセージ3
```

**JSON 形式**（`dialogs/キャラクター名.json`）：

```json
{
  "messages": ["メッセージ1", "メッセージ2", "メッセージ3"]
}
```

### ページトリガー

AI トリガーに WordPress 条件タグを使用：

- `is_single` - 単一投稿ページ
- `is_page` - 静的ページ
- `is_home` - ホームページ
- `is_front_page` - フロントページ
- 複数条件：`is_single,is_page`

### システムプロンプト例

**フレンドリーなキャラクター**：

```
あなたは親切なデスクトップアシスタントです。記事の内容を優しい口調で短くコメントしてください。30字以内でお願いします。
```

**プロフェッショナルなキャラクター**：

```
あなたはプロのブログアシスタントです。記事について簡潔で洞察に満ちたコメントを提供してください。50字以内で。
```

**遊び心のあるキャラクター**：

```
あなたは遊び心のあるデスクトップマスコットです。記事の内容を面白く、短く（40字以内）コメントしてください。
```

## 🔒 セキュリティ機能

- **CSRF 保護**：すべてのフォーム送信で WordPress nonce 検証を使用
- **XSS 防止**：WordPress コア関数を使用した入力サニタイズ
- **API Key 暗号化**：API Key は AES-256-CBC で暗号化して保存
- **安全なファイル操作**：すべてのファイル I/O は WordPress Filesystem API を使用し、パス検証付き
- **ディレクトリトラバーサル防止**：ファイルパスを検証して不正アクセスを防止
- **入力検証**：すべてのユーザー入力をサニタイズ・検証

## 📝 ファイル構造

```
mp-ukagaka/
├── includes/                      # PHPモジュール
│   ├── core-functions.php        # コア機能（設定管理）
│   ├── utility-functions.php     # ユーティリティ関数（セキュリティ）
│   ├── ai-functions.php          # AI機能（クラウドAPI + Ollama）
│   ├── llm-functions.php         # LLM機能（Ollama専用）- ベータ版
│   ├── ukagaka-functions.php     # ゴースト管理
│   ├── ajax-handlers.php         # AJAXハンドラー
│   ├── frontend-functions.php    # フロントエンド機能
│   └── admin-functions.php       # 管理機能
├── dialogs/                      # ダイアログファイル（TXT/JSON）
├── images/                       # 画像リソース
│   └── shell/                    # キャラクター画像
├── languages/                    # 言語ファイル
├── docs/                         # ドキュメント
├── mp-ukagaka.php               # メインプラグインファイル
├── ukagaka-core.js              # フロントエンドJS（コア）
├── ukagaka-features.js          # フロントエンドJS（機能）
├── ukagaka_cookie.js            # Cookieユーティリティ
└── mpu_style.css                # スタイルシート
```

## ❓ よくある質問

### API コストを抑えるには？

- **確率**を低い値に設定（10-20%）
- より速い/安価なモデルを使用（例：gemini-2.5-flash、gpt-4o-mini）
- トリガーページを制限（例：`is_single`のみ）

### AI がトリガーされないのはなぜ？

1. 設定で AI が有効になっているか確認
2. API Key が正しいか確認
3. ページがトリガー条件に一致しているか確認（例：`is_single`）
4. コンテンツ長が最小要件を満たしているか確認（500 文字）
5. 確率設定を確認（テスト時は 100%を試す）
6. ブラウザコンソールで JavaScript エラーを確認

### AI 会話が自動会話に上書きされる？

**AI 会話の表示時間**設定を増やしてください（秒単位）。これは AI メッセージが表示される時間を制御します。推奨：5-10 秒。

### AI 応答スタイルをカスタマイズするには？

**キャラクター設定（System Prompt）**フィールドを編集してください。これはキャラクターの個性と応答スタイルを定義します。200 文字以内を推奨。

### LLM 接続が失敗する

1. **ローカル接続**

   - Ollama サービスが実行中か確認
   - ポートが 11434 か確認
   - ブラウザで`http://localhost:11434`にアクセスしてみる

2. **リモート接続**
   - Cloudflare Tunnel サービスが実行中か確認
   - トンネル URL が正しいか確認
   - ネットワーク接続が正常か確認

### LLM 応答が遅い

1. より高速なモデルを使用（例：`qwen3:8b`）
2. 「思考モードを無効化」オプションを有効化
3. リモート接続には追加の遅延があります（正常な動作）

## 🐛 トラブルシューティング

### AI がトリガーされない

- ブラウザコンソールでエラーを確認
- API Key の有効性を確認
- 確率を 100%に設定してテスト
- ページコンテンツが十分か確認（>500 文字）

### キャラクターが表示されない

- 「ゴーストをデフォルトで表示」設定が有効か確認
- キャラクター画像パスが正しいか確認
- ブラウザキャッシュをクリア
- ページ除外ルールを確認

### ダイアログが読み込まれない

- ダイアログファイル形式を確認（TXT または JSON）
- ファイル名がキャラクター設定と一致しているか確認
- ファイルが`dialogs/`フォルダにあるか確認
- ファイル権限を確認

## 📜 変更履歴

### バージョン 2.1.6（2025-12-13）

**新機能：**

- ✨ **LLM**: WordPress 情報統合 - LLM がサイト情報にアクセスし、コメントできるようになりました
  - WordPress バージョン、テーマ情報（名前、バージョン、作成者）、PHP バージョン、サイト名
  - 統計情報：投稿数、コメント数、カテゴリ数、タグ数、運営日数
  - パフォーマンスのためのキャッシュメカニズム（5 分間）
  - 自スタイルの用語をカスタマイズ可能な統計プロンプト（詳細は [USER_GUIDE.md](docs/USER_GUIDE.md) を参照）
- ✨ **LLM**: 反復防止メカニズム - 以前の応答を追跡して「無駄話ループ」を防止
- ✨ **パフォーマンス**: アイドル検出 - ユーザーがアイドル状態（60 秒）のとき、自動会話を自動的に一時停止
  - ユーザーがページを離れたときの GPU リソースを節約
  - ユーザー活動を追跡（マウス移動、キーボード、スクロール、クリック）
  - ユーザーが戻ったときに自動的に再開

**改善：**

- 🔧 **LLM**: WordPress 関連のダイアログのための新しいプロンプトカテゴリ `wordpress_info` と `statistics` を追加
- 🔧 **LLM**: WordPress コンテキスト情報でシステムプロンプトを強化
- 🔧 **パフォーマンス**: ユーザーの非活動中に不要な LLM リクエストを削減

### バージョン 2.1.5（2025-12-13）

**構造変更：**

- 📁 **リファクタリング**：管理オプションページを専用の `options/` フォルダに再編成
  - すべてのオプションページファイル（options.php、options_page*.php）が `options/` ディレクトリに集約
  - コード組織と保守性の向上
  - includes と options の関心の分離の改善

**改善：**

- ✨ **LLM**: ランダム対話プロンプトシステムの改善（カテゴリ別プロンプト：挨拶、カジュアル、観察、コンテキスト、インタラクティブ）
- ✨ **LLM**: 時間認識コンテキストプロンプトの追加（朝、午後、夜、深夜）
- 🌍 **i18n**: 翻訳ファイルの完全な監査と更新
- 🌍 **i18n**: すべてのエラーメッセージと成功メッセージの翻訳を追加
- 🌍 **i18n**: すべての API エラーメッセージが適切に国際化されました
- 🔧 **i18n**: .po から .mo への変換を改善する翻訳コンパイルスクリプトを更新

**強化：**

- 🔧 **LLM**: プロンプトの多様性を 7 個から 20+ 個に拡大（5 カテゴリ）
- 🔧 **LLM**: より自然でコンテキストに応じたプロンプト表現
- 🔧 **i18n**: llm-functions.php、ai-functions.php、ajax-handlers.php のすべてのハードコード文字列が翻訳関数を使用

### バージョン 2.1.4（2025-12-11）

**改善：**

- ⚡ **AI**：Gemini の `maxOutputTokens` を 100 から 500 に増やし、コンテキスト認識処理中の応答切り捨てを防止（より長く完全な応答が可能に）。
- 💰 **AI**：コスト管理のため、OpenAI と Claude は 100 トークンのまま維持。

**バグ修正：**

- 🐛 **UI**：管理画面の「AI 会話テキスト色」入力の表示問題を修正（CSS パディングの競合によりカラーピッカーがつぶれて表示されていた問題を解決）。

### バージョン 2.1.3（2025-12-10）

**重大な変更：**

- 🔄 **破壊的変更**：システムは外部ダイアログファイル（TXT/JSON 形式）のみを使用
  - 内部ダイアログ保存機能を削除
  - すべてのダイアログは外部ファイルとして`dialogs/`フォルダに保存する必要があります
  - キャラクター設定を保存すると自動的にダイアログファイルが生成されます
- 🎨 **新規**：Claude スタイルの管理画面 UI を完全リデザイン
  - モダンでクリーンなデザイン、温かみのあるカラーパレット
  - 改善されたタブナビゲーションとコンテンツレイアウト
  - より良いメッセージ配置とフォーマット
  - モバイルデバイス対応のレスポンシブデザイン

**改善：**

- 🔧 **改善**：すべての管理ページでのメッセージ表示の一貫性向上
- 🔧 **改善**：重複メッセージ表示の問題を修正
- 🔧 **改善**：管理画面の幅を最適化（75%、左揃え）
- 🔧 **改善**：シャドウを削除してよりクリーンな外観に
- 🔧 **改善**：WordPress デフォルトの背景色を復元

**バグ修正：**

- 🐛 **修正**：メッセージボックスの配置の問題
- 🐛 **修正**：複数の管理ページでの保存メッセージの重複表示の問題

### バージョン 2.1.2（2025-12-08）

**新機能：**

- ✨ **新規（ベータ版）**：Ollama 統合によるローカル LLM サポート
- ✨ **新規**：Cloudflare Tunnel およびリモート接続サポート
- ✨ **新規**：ローカルとリモート接続の動的タイムアウト管理
- ✨ **新規**：自動サービス可用性チェック

**改善：**

- 🔧 **改善**：リモート接続のエラーメッセージを改善
- 🔧 **改善**：Ollama エンドポイントの URL 検証
- 🔧 **改善**：接続タイプ検出（ローカル/リモート）

**バグ修正：**

- 🐛 **修正**：LLM 有効化チェックボックスの状態永続化の問題

### バージョン 2.1.1（2025-11-28）

**バグ修正：**

- 🐛 CSS の安定性改善、テーマ互換性向上（Twenty Ten など）
- 🐛 ナビゲーションボタンのホバー効果がすべてのテーマで正常に動作
- 🐛 ダイアログボタン（OK/Cancel）のフォーカス枠線を削除

**改善：**

- 🔧 Flexbox レイアウトによるボタン配置の改善
- 🔧 テーマ CSS の上書きを防ぐ `!important` ルールを追加
- 🔧 ドック要素の完全な CSS リセット

### バージョン 2.1.0（2025-11-26）

**新機能：**

- ✨ タイプライター速度の設定（10-200 ミリ秒/文字）
- 🔒 API Key を AES-256-CBC で暗号化
- 🔒 WordPress Filesystem API を使用した安全なファイル操作
- 🔒 ディレクトリトラバーサル防止

**改善：**

- 🔧 設定済み API Key の視覚的インジケーター
- 🔧 ファイル操作エラーメッセージの改善
- 🔧 既存の平文 API Key との後方互換性

### バージョン 2.0.0（2025-11-22）

**アーキテクチャ改善：**

- ✨ 完全なモジュラーアーキテクチャ（7 モジュール）
- ✨ メインプラグインファイルを約 85 行に削減

**新機能：**

- ✨ マルチプロバイダー対応 AI コンテキスト認識（Gemini、OpenAI、Claude）
- ✨ 初回訪問者挨拶（Slimstat 統合）
- ✨ AI テキスト色と表示時間の設定

**改善：**

- 🔧 JSON ダイアログファイルサポート
- 🔧 エラー処理とログの改善

## 👥 クレジット

- **オリジナル作者**：Ariagle _（元のサイトは運営終了）_
- **メンテナー**：Horlicks (https://www.moelog.com/)
- **インスピレーション**：クラシック MP Ukagaka プラグイン / 伺か (Ukagaka)

## 📄 ライセンス

このプラグインはオリジナルの MP Ukagaka プラグインをベースにしています。オリジナルプラグインのライセンス条項を参照してください。

## 🔗 リンク

- [萌えログ.COM](https://www.moelog.com/)
- [Wikipedia - 伺か](http://en.wikipedia.org/wiki/Ukagaka)
- [Google AI Studio](https://makersuite.google.com/app/apikey)（Gemini API Key）
- [OpenAI Platform](https://platform.openai.com/api-keys)（OpenAI API Key）
- [Anthropic Console](https://console.anthropic.com/)（Claude API Key）

## 💬 サポート

問題や提案がありましたら：

- [萌えログ.COM](https://www.moelog.com/)を訪問
- WordPress 管理画面の FAQ セクションを確認
- 上記のトラブルシューティングセクションを参照
- GitHub で Issue を開く

---

**Made with ❤ for WordPress コミュニティ**
