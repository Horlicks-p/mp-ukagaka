# MP Ukagaka 版本歷史

> 📋 所有版本的更新記錄

---

## [2.1.6] - 2025-12-13

### ✨ 新功能

- **WordPress 資訊整合**：LLM 自發對話現在可以獲取並評論網站資訊
  - 整合 WordPress 版本、主題資訊（名稱、版本、作者）、PHP 版本、網站名稱
  - 統計資訊：文章數、留言數、分類數、標籤數、運營日數
  - 使用 transient 快取機制（5 分鐘），提升效能
  - 新增 `wordpress_info` 和 `statistics` 兩類提示詞分類

- **RPG 風格統計資訊**：統計資訊使用遊戲化術語
  - 魔族遭遇回数（文章數）
  - 最大ダメージ（留言數）
  - 習得スキル総数（分類數）
  - アイテム使用回数（TAG數）
  - 冒険日数（運營日數）

- **防止重複對話機制**：避免「廢話迴圈」問題
  - 追蹤上一次 LLM 生成的回應
  - 提示詞中加入避免重複的指令
  - 自動生成不同的閒聊內容或保持沉默

- **閒置偵測功能**：自動暫停自動對話以節省資源
  - 偵測使用者活動（滑鼠、鍵盤、滾動、點擊）
  - 60 秒閒置閾值（可調整）
  - 使用者返回時自動恢復
  - 有效節省 GPU 和網路資源

### 🔧 改進

- **LLM 系統提示詞增強**：加入 WordPress 網站資訊作為背景知識
- **提示詞多樣性提升**：新增 WordPress 相關和統計資訊相關的提示詞
- **效能優化**：減少不必要的 LLM 請求
- **資源管理**：更好的 GPU 和網路資源使用控制

### 📝 技術細節

- 新增 `mpu_get_wordpress_info()` 函數（位於 `includes/utility-functions.php`）
- 修改 `mpu_generate_llm_dialogue()` 函數，整合 WordPress 資訊
- 前端 JavaScript 加入閒置偵測邏輯（`ukagaka-core.js`）
- AJAX 處理器支援 `last_response` 參數

---

## [2.1.0] - 2025-11-26

### ✨ 新功能

- **可配置打字速度**：新增打字效果速度設定（10-200 毫秒/字）
- **API Key 加密存儲**：使用 AES-256-CBC 加密所有 API Key
- **安全文件操作**：使用 WordPress Filesystem API 進行所有文件讀寫
- **目錄遍歷防護**：驗證所有文件路徑，防止未授權存取

### 🔧 改進

- 已設定的 API Key 會顯示綠色勾勾指示器
- 改善文件操作的錯誤訊息
- 向下相容：支援現有的明文 API Key 自動加密

### 🔒 安全性

- 所有 API Key 使用 AES-256-CBC 加密
- 文件操作使用 WordPress Filesystem API
- 新增路徑驗證防止目錄遍歷攻擊

---

## [2.0.0] - 2025-11-22

### 🏗️ 架構改進

- **完全模組化重構**：將單一檔案拆分為 7 個獨立模組
- **主程式精簡**：`mp-ukagaka.php` 精簡至約 85 行
- **依賴順序載入**：模組按依賴關係順序載入

### ✨ 新功能

- **AI 頁面感知**：根據文章內容自動生成 AI 評論
- **多 AI 提供商支援**：
  - Google Gemini（gemini-2.5-flash、gemini-2.5-pro）
  - OpenAI GPT（GPT-4o、GPT-4o-mini、GPT-3.5-turbo）
  - Anthropic Claude（Claude Sonnet 4.5）
- **首次訪客打招呼**：對新訪客顯示個性化歡迎訊息
- **Slimstat 整合**：獲取訪客來源、地區等資訊
- **AI 文字顏色**：可自訂 AI 回應的文字顏色
- **AI 顯示時間控制**：設定 AI 訊息顯示時長

### 🔧 改進

- **JSON 對話檔案支援**：除 TXT 外，新增 JSON 格式支援
- **改善錯誤處理**：更詳細的錯誤日誌
- **效能優化**：設定讀取使用快取機制

### 📁 模組結構

```
includes/
├── core-functions.php      # 核心功能
├── utility-functions.php   # 工具函數
├── ai-functions.php        # AI 功能
├── ukagaka-functions.php   # 春菜管理
├── ajax-handlers.php       # AJAX 處理
├── frontend-functions.php  # 前端功能
└── admin-functions.php     # 後台功能
```

---

## [1.9.x] - 歷史版本

### 1.9.5
- 修復部分主題相容性問題
- 改善對話顯示效果

### 1.9.4
- 新增自動對話功能
- 新增對話間隔時間設定

### 1.9.3
- 新增外部對話檔案支援（TXT 格式）
- 新增多春菜切換功能

### 1.9.2
- 新增頁面排除功能
- 改善行動裝置顯示

### 1.9.1
- 新增固定訊息功能
- 新增通用會話功能

### 1.9.0
- 新增點擊行為設定
- 新增會話順序設定

---

## [1.8.x] - 歷史版本

### 1.8.5
- 新增 jQuery 相容性修復
- 改善 WordPress 5.x 相容性

### 1.8.0
- 新增多語言支援
- 新增繁體中文、日文翻譯

---

## [1.7.x] - 歷史版本

### 1.7.0
- 新增春菜管理介面
- 新增創建新春菜功能

---

## [1.6.x] - 歷史版本

### 1.6.0
- 新增擴展頁面
- 新增自訂 JavaScript 功能

---

## [1.5.x] - 歷史版本

### 1.5.0
- 初始公開版本
- 基本春菜顯示功能
- 基本對話功能

---

## 升級指南

### 從 1.x 升級到 2.x

1. **備份設定**
   - 建議先備份 `wp_options` 中的 `mpu_opt` 選項

2. **升級外掛**
   - 上傳新版本覆蓋舊版本
   - 或透過 WordPress 後台更新

3. **檢查設定**
   - 升級後設定會自動保留
   - 建議檢查所有設定頁面確認無誤

4. **清除快取**
   - 清除瀏覽器快取
   - 清除 WordPress 快取外掛的快取

### 從 2.0.x 升級到 2.1.x

1. **API Key 自動加密**
   - 現有的明文 API Key 會在第一次儲存設定時自動加密
   - 無需手動操作

2. **檢查文件權限**
   - 確保 `dialogs/` 資料夾可寫入
   - WordPress Filesystem API 需要適當權限

---

## 已知問題

### 2.1.0
- 部分舊版 PHP（< 7.4）可能不支援加密功能
- 建議升級至 PHP 7.4 或以上

### 2.0.0
- AI 功能需要穩定的網路連線
- 部分防火牆可能阻擋 AI API 請求

---

## 回報問題

如發現問題，請提供以下資訊：

1. WordPress 版本
2. PHP 版本
3. 外掛版本
4. 錯誤訊息（如有）
5. 瀏覽器控制台錯誤（按 F12 查看）

---

## 貢獻者

- **原作者**：Ariagle *(原站點已停止運營)*
- **維護者**：Horlicks ([MoeLog](https://www.moelog.com/))

---

**感謝所有使用者的支持與回饋！** ❤️

