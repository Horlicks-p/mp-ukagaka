# MP Ukagaka

WordPress サイトにインタラクティブな伺か（デスクトップマスコット）キャラクターを作成・表示するプラグイン。AI コンテキスト認識機能搭載。

[![プラグインバージョン](https://img.shields.io/badge/version-2.2.0-blue.svg)](https://github.com)
[![WordPress](https://img.shields.io/badge/WordPress-5.0%2B-blue.svg)](https://wordpress.org/)
[![PHP](https://img.shields.io/badge/PHP-7.4%2B-purple.svg)](https://www.php.net/)

🌍 **他の言語**: [English](README.md) | [繁體中文](README_zh-TW.md)

## 🎉 特別告知

**『葬送のフリーレン』第2期** の **2026年1月16日** 放送開始を記念して、デフォルトキャラクターを **初音ミク** から **フリーレン** に変更しました。

## 📸 スクリーンショット

![MP Ukagaka デモ](screenshot.PNG)

_フリーレンが記事内容に基づいて AI 生成のダイアログを表示_

## 📖 概要

MP Ukagaka は、WordPress サイトにカスタムのインタラクティブなデスクトップマスコットキャラクターを作成できるプラグインです。クラシックな MP Ukagaka プラグインをベースに、セキュリティ強化、パフォーマンス改善、モジュラーアーキテクチャ、最先端の AI 機能で完全に現代化されています。

### クラシック機能

- **複数キャラクター対応**：複数のゴーストキャラクターを作成・管理
- **カスタムダイアログ**：各キャラクター専用のメッセージを設計
- **外部ダイアログファイル**：TXT または JSON ファイルからダイアログを読み込み
- **自動会話**：設定可能な間隔で自動メッセージ切り替え
- **共通メッセージ**：全キャラクターに適用される共有メッセージ
- **ページ除外**：ゴーストを表示するページを制御
- **多言語対応**：繁体中国語、日本語、英語など複数言語をサポート
- **Canvas アニメーション**：単一の静的画像と複数フレームアニメーションをサポート
  - アニメーションシーケンスの自動フォルダ検出
  - キャラクターが話しているときのみアニメーションを再生（リソース節約）
  - フレームレート：180 ミリ秒/フレーム
  - 対応形式：PNG、JPG、JPEG、GIF、WebP

### 🚀 AI コンテキスト認識（v2.0.0 の新機能）

ページ内容を分析し、パーソナライズされた応答を生成するインテリジェントな AI 機能：

- **マルチプロバイダー AI サポート**：
  - **Google Gemini**：高速で効率的（gemini-2.5-flash、gemini-2.5-pro）
  - **OpenAI GPT**：強力な言語モデル（GPT-4o、GPT-4o-mini、GPT-3.5-turbo）
  - **Anthropic Claude**：高度な推論能力（Claude Sonnet 4.5）
- **スマートコンテンツ分析**：ページタイトルと内容を自動抽出・分析
- **設定可能なトリガー**：AI 会話を発動するページを設定
- **確率制御**：AI 応答頻度を調整（1-100%）して API コストを管理
- **カスタマイズ可能な性格**：システムプロンプトでキャラクターの個性を設計
- **ビジュアルカスタマイズ**：AI 会話のテキスト色をカスタマイズ
- **表示時間制御**：AI 会話が自動会話に上書きされるのを防止
- **多言語 AI**：繁体中国語、日本語、または英語で応答を生成
- **初回訪問者挨拶**：新規訪問者をパーソナライズされた AI 挨拶で歓迎（Slimstat プラグイン必要）

### 🤖 ユニバーサル LLM インターフェース（v2.2.0）

> 💡 **重要更新**：LLM 機能が**ユニバーサル LLM インターフェース**にアップグレードされました！

プラグインは複数の AI サービスをサポートする統一インターフェースを提供し、以下のいずれかのサービスを使用してダイアログを生成できます：

- **Ollama**（ローカル/リモート）：完全無料、API Key 不要
  - ローカルまたはリモートの Ollama インスタンスに接続
  - Cloudflare Tunnel、ngrok、その他のトンネルサービスをサポート
  - スマート接続検出、タイムアウト設定を自動調整
  - モデルサポート：Qwen3、Llama、Mistral など
  - 思考モード制御（Qwen3、DeepSeek などのモデル）

- **Google Gemini**：API Key が必要
  - サポートモデル：Gemini 2.5 Flash（推奨）、Gemini 1.5 Pro など

- **OpenAI**：API Key が必要
  - サポートモデル：GPT-4.1 Mini（推奨）、GPT-4o など

- **Claude (Anthropic)**：API Key が必要
  - サポートモデル：Claude Sonnet 4.5、Claude Haiku 4.5、Claude Opus 4.5

**主な機能：**

- **統一設定インターフェース**：すべてのプロバイダーが同じ設定ページを使用
- **API Key 暗号化**：すべての API Key が自動的に暗号化されて保存され、セキュリティを確保
- **接続テスト**：すべての AI プロバイダーにテストボタンを追加
- **組み込みダイアログの置き換え**：静的ダイアログを AI 生成コンテンツに置き換えるオプション（すべてのプロバイダーをサポート）
- **最適化された System Prompt**：XML 構造化 System Prompt、70+ のフリーレンスタイルダイアログ例を含む
- **WordPress 情報統合**：LLM ダイアログにサイト情報を含めることが可能（WordPress バージョン、テーマ情報、統計情報）
- **反復防止メカニズム**：以前の応答を追跡し、繰り返しのアイドル会話を防止
- **アイドル検出機能**：ユーザーがアイドル状態（60 秒）のとき、自動会話を自動的に一時停止し、GPU とネットワークリソースを節約

**セットアップ要件：**

- ローカルまたはリモートサーバーに[Ollama](https://ollama.ai/)をインストール・実行
- 希望するモデルをダウンロード（例：`ollama pull qwen3:8b`）
- プラグイン設定でエンドポイント URL を設定（ローカル：`http://localhost:11434`またはリモート：`https://your-domain.com`）
- 詳細なセットアップ手順については、[USER_GUIDE.md](/docs/USER_GUIDE.md)を参照してください

**現在の制限事項：**

- 機能はテスト段階
- リモートセットアップで接続の問題が発生する可能性
- 応答時間はモデルと接続タイプによって異なる場合があります

## 📦 インストール

1. **プラグインをダウンロード**

   - このリポジトリからダウンロード
   - または WordPress プラグインディレクトリにクローン

2. **プラグインをインストール**

   ```bash
   # WordPressプラグインディレクトリに移動
   cd /path/to/wordpress/wp-content/plugins/

   # 解凍またはクローン
   unzip mp-ukagaka.zip
   ```

3. **プラグインを有効化**

   - WordPress 管理画面 → プラグインに移動
   - 「MP Ukagaka」を見つけて「有効化」をクリック

4. **設定**
   - **設定 → MP Ukagaka**に移動
   - 一般設定を構成し、最初のゴーストキャラクターを作成
   - （オプション）「AI 設定」セクションで AI 機能を有効化

## ⚙️ 設定

### 基本設定

1. **一般設定**

   - デフォルトゴーストキャラクターを選択
   - 表示の有効化/無効化
   - 自動会話間隔を設定
   - ページ除外ルールを設定

2. **キャラクター作成**

   - 「ゴースト」タブに移動
   - カスタム画像とダイアログで新しいキャラクターを追加
   - キャラクター固有の設定を構成

3. **ダイアログ設定**
   - **重要**：すべてのダイアログは外部ファイルとして保存する必要があります（TXT または JSON 形式）
   - ダイアログファイルを`dialogs/`フォルダに配置
   - キャラクター設定を保存すると自動的にダイアログファイルが生成されます
   - `dialogs/`フォルダで手動でダイアログファイルを作成/編集することもできます

### AI コンテキスト認識設定

1. **AI 機能を有効化**

   - 設定 → MP Ukagaka → AI 設定に移動
   - 「ページ認識機能を有効にする」をチェック

   - **言語設定**：応答言語を選択（繁体中国語、日本語、英語）
   - **キャラクター設定（System Prompt）**：キャラクターの個性を定義
     - この設定は最適化された System Prompt システムと統合されます
     - クラウド AI サービス：System Prompt は自動的に最適化され、token 使用量を削減します
     - ローカル LLM：より長いプロンプトを使用して、より良いキャラクターの一貫性を得ることができます
   - **頁面感知確率（%）**：AI トリガー率を設定（1-100%、コスト管理には 10-30%推奨）
   - **トリガーページ**：AI をトリガーするページを指定（例：「is_single」で単一投稿のみ）
   - **AI会話の表示時間（秒）**：AI メッセージの表示時間を設定（5-10 秒推奨）
   - **初回訪問者への挨拶**：有効化して挨拶プロンプトを設定（オプション）

4. **設定を保存**
   - 「保存」ボタンをクリック
   - 単一投稿ページで AI 応答をテスト

### ユニバーサル LLM 設定

1. **AI プロバイダーを選択**

   **設定 → MP Ukagaka → LLM 設定**に移動し、以下のいずれかの AI プロバイダーを選択：

   **Ollama**（無料、API Key 不要）：
   - ローカルマシンまたはサーバーに[Ollama](https://ollama.ai/)をインストール・実行
   - モデルをダウンロード：`ollama pull qwen3:8b`（または希望のモデル）
   - エンドポイントを入力：`http://localhost:11434`（ローカル）または `https://your-domain.com`（リモート）
   - モデル名を入力（例：`qwen3:8b`、`llama3.2`、`mistral`）
   - 「Ollama 接続をテスト」ボタンで設定を確認

   **Google Gemini**（初心者におすすめ）：
   - [Google AI Studio](https://makersuite.google.com/app/apikey)から API Key を取得
   - API Key を入力（自動暗号化）
   - モデルを選択：Gemini 2.5 Flash（推奨）、Gemini 1.5 Pro など
   - 「接続テスト」ボタンで設定を確認

   **OpenAI**：
   - [OpenAI Platform](https://platform.openai.com/api-keys)から API Key を取得
   - API Key を入力（自動暗号化）
   - モデルを選択：GPT-4.1 Mini（推奨）、GPT-4o など
   - 「接続テスト」ボタンで設定を確認

   **Claude (Anthropic)**：
   - [Anthropic Console](https://console.anthropic.com/)から API Key を取得
   - API Key を入力（自動暗号化）
   - モデルを選択：Claude Sonnet 4.5（推奨）、Claude Haiku 4.5、Claude Opus 4.5
   - 「接続テスト」ボタンで設定を確認

2. **LLM 設定を構成**

   - **組み込みダイアログを置き換える**：静的ダイアログを LLM 生成ダイアログに置き換える（すべてのプロバイダーをサポート）
   - **ページ認識機能**：ページ認識機能が有効かどうかを制御
   - **思考モードを無効化**：Qwen3、DeepSeek モデルに推奨（Ollama のみ）

3. **AI 設定（ページ認識）を構成**

   **設定 → MP Ukagaka → AI 設定**に移動してページ認識機能を設定：

## 🔧 高度な機能

### 外部ダイアログファイル

> ⚠️ **重要**：バージョン 2.1.3 以降、システムは**外部ダイアログファイルのみを使用**します。すべてのダイアログは外部ファイルとして`dialogs/`フォルダに保存する必要があります。内部ダイアログ保存機能は削除されました。

外部ファイルからダイアログを読み込むことができます（TXT または JSON 形式）：

**TXT 形式**（`dialogs/キャラクター名.txt`）：

```
メッセージ1

メッセージ2

メッセージ3
```

**JSON 形式**（`dialogs/キャラクター名.json`）：

```json
{
  "messages": ["メッセージ1", "メッセージ2", "メッセージ3"]
}
```

### 特殊コード

ダイアログファイルで特殊コードを使用して動的コンテンツを表示できます：

| コード              | 説明                                    |
| ----------------- | --------------------------------------- |
| `:recentpost[n]:` | 最新 n 件の投稿リストを表示（クリック可能なリンク） |
| `:randompost[n]:` | n 件のランダムな投稿リストを表示（クリック可能なリンク） |
| `:commenters[n]:` | 最新 n 人のコメンターを表示（ウェブサイトがある場合はリンクとして表示） |

**使用例：**

```
最近の記事：:recentpost[3]:

おすすめの記事：:randompost[5]:

最近コメントしてくれた方：:commenters[5]:
```

> 📌 **注意**：特殊コードはサーバー側で処理され、HTML リンクに変換されてからフロントエンドに送信されます。これらのコードは TXT と JSON 形式のダイアログファイルの両方で使用できます。旧形式 `(:recentpost[5]:)`（括弧付き）も後方互換性のためにサポートされています。

### ページトリガー

AI トリガーに WordPress 条件タグを使用：

- `is_single` - 単一投稿ページ
- `is_page` - 静的ページ
- `is_home` - ホームページ
- `is_front_page` - フロントページ
- 複数条件：`is_single,is_page`

### システムプロンプト例

**フレンドリーなキャラクター**：

```
あなたは親切なデスクトップアシスタントです。記事の内容を優しい口調で短くコメントしてください。30字以内でお願いします。
```

**プロフェッショナルなキャラクター**：

```
あなたはプロのブログアシスタントです。記事について簡潔で洞察に満ちたコメントを提供してください。50字以内で。
```

**遊び心のあるキャラクター**：

```
あなたは遊び心のあるデスクトップマスコットです。記事の内容を面白く、短く（40字以内）コメントしてください。
```

## 🔒 セキュリティ機能

- **CSRF 保護**：すべてのフォーム送信で WordPress nonce 検証を使用
- **XSS 防止**：WordPress コア関数を使用した入力サニタイズ
- **API Key 暗号化**：API Key は AES-256-CBC で暗号化して保存
- **安全なファイル操作**：すべてのファイル I/O は WordPress Filesystem API を使用し、パス検証付き
- **ディレクトリトラバーサル防止**：ファイルパスを検証して不正アクセスを防止
- **入力検証**：すべてのユーザー入力をサニタイズ・検証

## ❓ よくある質問

### API コストを抑えるには？

- **確率**を低い値に設定（10-20%）
- より速い/安価なモデルを使用（例：gemini-2.5-flash、gpt-4o-mini）
- トリガーページを制限（例：`is_single`のみ）

### AI がトリガーされないのはなぜ？

1. 設定で AI が有効になっているか確認
2. API Key が正しいか確認
3. ページがトリガー条件に一致しているか確認（例：`is_single`）
4. コンテンツ長が最小要件を満たしているか確認（500 文字）
5. 確率設定を確認（テスト時は 100%を試す）
6. ブラウザコンソールで JavaScript エラーを確認

### AI 会話が自動会話に上書きされる？

**AI 会話の表示時間**設定を増やしてください（秒単位）。これは AI メッセージが表示される時間を制御します。推奨：5-10 秒。

### AI 応答スタイルをカスタマイズするには？

**キャラクター設定（System Prompt）**フィールドを編集してください。これはキャラクターの個性と応答スタイルを定義します。

**クラウド AI サービス**（Gemini、OpenAI、Claude）：API コストと応答速度を管理するため、200-300 文字以内を推奨します。

**ローカル LLM**（Ollama）：API コストの制限がないため、より長く詳細なプロンプト（1000 文字以上でも可）を使用できます。長いプロンプトは通常、より良いキャラクターの一貫性と個性定義をもたらします。

### LLM 接続が失敗する

1. **ローカル接続**

   - Ollama サービスが実行中か確認
   - ポートが 11434 か確認
   - ブラウザで`http://localhost:11434`にアクセスしてみる

2. **リモート接続**
   - Cloudflare Tunnel サービスが実行中か確認
   - トンネル URL が正しいか確認
   - ネットワーク接続が正常か確認

### LLM 応答が遅い

1. より高速なモデルを使用（例：`qwen3:8b`）
2. 「思考モードを無効化」オプションを有効化
3. リモート接続には追加の遅延があります（正常な動作）

## 🐛 トラブルシューティング

### AI がトリガーされない

- ブラウザコンソールでエラーを確認
- API Key の有効性を確認
- 確率を 100%に設定してテスト
- ページコンテンツが十分か確認（>500 文字）

### キャラクターが表示されない

- 「ゴーストをデフォルトで表示」設定が有効か確認
- キャラクター画像パスが正しいか確認
- ブラウザキャッシュをクリア
- ページ除外ルールを確認

### ダイアログが読み込まれない

- ダイアログファイル形式を確認（TXT または JSON）
- ファイル名がキャラクター設定と一致しているか確認
- ファイルが`dialogs/`フォルダにあるか確認
- ファイル権限を確認

## 📝 ファイル構造

```
mp-ukagaka/
├── includes/                      # PHP モジュール化コンポーネント
│   ├── core-functions.php        # コア機能（設定、オプション）
│   ├── utility-functions.php     # ユーティリティ関数（文字列/配列、フィルタリング、セキュリティ）
│   ├── ai-functions.php          # AI 機能（Gemini、OpenAI、Claude API 呼び出し）
│   ├── prompt-categories.php     # プロンプトカテゴリ管理
│   ├── llm-functions.php         # LLM 機能（Ollama 統合）
│   ├── ukagaka-functions.php     # うかがか管理（CRUD、メッセージ処理）
│   ├── ajax-handlers.php         # AJAX ハンドラー（すべての AJAX エンドポイント）
│   ├── frontend-functions.php    # フロントエンド機能（HTML、アセット、表示ロジック）
│   └── admin-functions.php        # 管理機能（設定保存、管理ページ）
├── options/                       # 管理オプションページ
│   ├── options.php               # 管理ページフレームワーク
│   ├── options_page0.php         # 一般設定
│   ├── options_page1.php         # キャラクター管理
│   ├── options_page2.php         # 新規キャラクター作成
│   ├── options_page3.php         # 拡張機能
│   ├── options_page4.php         # ダイアログ管理
│   ├── options_page_ai.php      # AI 設定（コンテキスト認識）
│   └── options_page_llm.php      # LLM 設定（Ollama）- ベータ版
├── dialogs/                      # ダイアログファイル（TXT/JSON）
├── images/                       # キャラクター画像
│   └── shell/                    # キャラクターシェル画像
├── js/                           # JavaScript ファイル（v2.1.7+）
│   ├── ukagaka-base.js          # ベース層（config + utils + ajax）
│   ├── ukagaka-core.js          # コア機能（ui + dialogue + キャラクター切り替え）
│   ├── ukagaka-features.js      # 機能モジュール（ai + external + events）
│   ├── ukagaka-anime.js         # Canvas アニメーションマネージャー
│   ├── ukagaka-cookie.js        # Cookie 処理ユーティリティ
│   └── ukagaka-textarearesizer.js # 管理画面テキストエリアリサイザー
├── languages/                    # 翻訳ファイル
├── mp-ukagaka.php               # メインプラグインファイル（モジュールローダー）
├── mpu_style.css                # スタイルシート
├── readme.txt                   # WordPress.org readme
└── README_ja.md                  # このファイル
```

## 📜 変更履歴

### バージョン 2.2.0（2025-12-19）

**🚀 重大更新：ユニバーサル LLM インターフェース**

- **マルチ AI プロバイダーサポート**：4 つの AI サービスをサポートする統一インターフェース
  - **Ollama**：ローカル/リモート無料 LLM（API Key 不要）
  - **Google Gemini**：Gemini 2.5 Flash（推奨）、Gemini 1.5 Pro などをサポート
  - **OpenAI**：GPT-4.1 Mini（推奨）、GPT-4o などをサポート
  - **Claude (Anthropic)**：Claude Sonnet 4.5、Claude Haiku 4.5、Claude Opus 4.5 をサポート
  - すべてのプロバイダーが統一設定インターフェースを使用し、いつでも切り替え可能

- **API Key 暗号化保存**：すべての API Key が自動的に暗号化されて保存され、セキュリティを確保
- **接続テスト機能**：すべての AI プロバイダーに接続テストボタンを追加

**🧠 System Prompt 最適化システム**

- **XML 構造化設計**：XML タグを使用して System Prompt を整理し、LLM の理解効率を向上
  - `<character>`：キャラクター名とコア設定
  - `<knowledge_base>`：圧縮された WordPress 情報
  - `<behavior_rules>`：行動ルール（must_do、should_do、must_not_do）
  - `<response_style_examples>`：70+ のダイアログ例
  - `<current_context>`：現在のコンテキスト情報

- **コンテキスト圧縮メカニズム**：WordPress、ユーザー、訪問者情報を自動的に圧縮し、token 使用量を削減
- **フリーレンスタイル例システム**：12 カテゴリをカバーする 70+ の実際のダイアログ例を内蔵
- **二層アーキテクチャ設計**：System Prompt がスタイルを定義し、User Prompt がタスク指示を提供

**🎨 UI/UX 全面アップグレード**

- **統一カードデザイン**：すべての設定ページが一貫したカードベースのレイアウトを使用
- **二列レイアウト**：メインコンテンツ + サイドバーデザイン（メインコンテンツ 55%、サイドバー 300px）
- **カスタムスクロールバースタイル**：長いテキスト領域に美しいスクロールバーを追加

**🔧 機能改善**

- **ページ認識機能統合**：「ページ認識機能」設定を LLM 設定ページに移動
- **AI 設定ページ簡素化**：「ページ認識」機能に焦点を当て
- **統計メタファー最適化**：ゲーム化された統計メタファーを復元および最適化

**📝 コード最適化**

- **新機能**：mpu_build_optimized_system_prompt、mpu_build_frieren_style_examples、mpu_build_prompt_categories、mpu_compress_context_info、mpu_get_visitor_status_text、mpu_calculate_text_similarity、mpu_debug_system_prompt
- **関数リファクタリング**：mpu_generate_llm_dialogue が新しい最適化された System Prompt システムを使用
- **後方互換性**：古い設定のサポートを維持し、設定キーの自動移行

**🐛 バグ修正**

- 統計メタファーのマッピングを修正
- テキストエリアの幅設定を最適化（850px に統一）
- メインメニューの下部ラインの配置を修正
- スクロールバーのスタイル問題を修正

**🎉 特別更新（2025-12-19）**

- 『葬送のフリーレン』第2期の2026年1月16日放送開始を記念して、デフォルトキャラクターを初音ミクからフリーレンに変更

---

### バージョン 2.1.7（2025-12-15）

**パフォーマンス最適化：**

- 🚀 **JavaScript ファイル構造リファクタリング**：10 個の JS ファイルを 4 個に統合し、HTTP リクエストを削減
  - `ukagaka-base.js`：config + utils + ajax を統合（ベース層）
  - `ukagaka-core.js`：ui + dialogue + core を統合（コア機能）
  - `ukagaka-features.js`：ai + external + events を統合（機能モジュール）
  - `ukagaka-anime.js`：独立保持（アニメーションモジュール）
  - すべてのファイルを `ukagaka-` プレフィックスで統一命名
- 🚀 **mousemove ログ最適化**：頻繁にトリガーされるログ記録を削除し、コンソールのフラッディングを回避

**機能改善：**

- 🔧 **LLM リクエスト最適化**：POST 方式に変更し、URL 長さ制限を回避
  - すべてのパラメータを `FormData` で渡す
  - バックエンドは POST と GET の両方式をサポート（後方互換性）
  - `wp_unslash()` を使用して WordPress の JSON データを正しく処理
- 🔧 **LLM リクエスト連打防止**：`cancelPrevious: true` オプションを追加
  - ユーザーが「次へ」を素早く連続クリックした場合、前の未完了リクエストを自動的にキャンセル
  - 複数の並列リクエストがタイプライター効果を上書きすることを回避

**エラー処理最適化：**

- 🐛 **Canvas アニメーションエラー処理**：`mpuChange` 関数の開始時に Canvas Manager をチェック
  - `window.mpuCanvasManager` の存在を事前にチェック
  - Ajax 成功後にエラーを発見することを回避
- 🐛 **LLM エラー視覚的フィードバック**：デバッグモードでエラーメッセージを表示
  - 表示形式：`[LLM エラー: エラーメッセージ]`
  - 2 秒後に自動的にフォールバックダイアログに切り替え

**その他の改善：**

- 📝 ファイル命名規則の統一：すべての JavaScript ファイルに `ukagaka-` プレフィックスを使用
  - `jquery.textarearesizer.compressed.js` → `ukagaka-textarearesizer.js`

### バージョン 2.1.6（2025-12-14）

**新機能：**

- ✨ **Canvas アニメーション**：複数フレームキャラクターアニメーションをサポート
  - アニメーションシーケンスの自動フォルダ検出
  - キャラクターが話しているときのみアニメーションを再生（リソース節約）
  - 単一の静的画像との後方互換性
  - フレームレート：180 ミリ秒/フレーム
  - 対応形式：PNG、JPG、JPEG、GIF、WebP
  - 詳細は [Canvas カスタマイズガイド](docs/CANVAS_CUSTOMIZATION.md) を参照
  - 作成者のウェブサイト [www.moelog.com](https://www.moelog.com/) で実際の動作を確認できます
- ✨ **LLM**: WordPress 情報統合 - LLM がサイト情報にアクセスし、コメントできるようになりました
  - WordPress バージョン、テーマ情報（名前、バージョン、作成者）、PHP バージョン、サイト名
  - 統計情報：投稿数、コメント数、カテゴリ数、タグ数、運営日数
  - パフォーマンスのためのキャッシュメカニズム（5 分間）
  - 自スタイルの用語をカスタマイズ可能な統計プロンプト（詳細は [USER_GUIDE.md](docs/USER_GUIDE.md) を参照）
- ✨ **LLM**: 反復防止メカニズム - 以前の応答を追跡して「無駄話ループ」を防止
- ✨ **パフォーマンス**: アイドル検出 - ユーザーがアイドル状態（60 秒）のとき、自動会話を自動的に一時停止
  - ユーザーがページを離れたときの GPU リソースを節約
  - ユーザー活動を追跡（マウス移動、キーボード、スクロール、クリック）
  - ユーザーが戻ったときに自動的に再開

**改善：**

- 🔧 **LLM**: WordPress 関連のダイアログのための新しいプロンプトカテゴリ `wordpress_info` と `statistics` を追加
- 🔧 **LLM**: WordPress コンテキスト情報でシステムプロンプトを強化
- 🔧 **パフォーマンス**: ユーザーの非活動中に不要な LLM リクエストを削減

### バージョン 2.1.2（2025-12-08）

**新機能：**

- ✨ **新規（ベータ版）**：Ollama 統合によるローカル LLM サポート
- ✨ **新規**：Cloudflare Tunnel およびリモート接続サポート
- ✨ **新規**：ローカルとリモート接続の動的タイムアウト管理
- ✨ **新規**：自動サービス可用性チェック

**改善：**

- 🔧 **改善**：リモート接続のエラーメッセージを改善
- 🔧 **改善**：Ollama エンドポイントの URL 検証
- 🔧 **改善**：接続タイプ検出（ローカル/リモート）

**バグ修正：**

- 🐛 **修正**：LLM 有効化チェックボックスの状態永続化の問題

**アーキテクチャ改善：**

- ✨ 完全なモジュラーアーキテクチャ（7 モジュール）
- ✨ メインプラグインファイルを約 85 行に削減

**新機能：**

- ✨ マルチプロバイダー対応 AI コンテキスト認識（Gemini、OpenAI、Claude）
- ✨ 初回訪問者挨拶（Slimstat 統合）
- ✨ AI テキスト色と表示時間の設定

**改善：**

- 🔧 JSON ダイアログファイルサポート
- 🔧 エラー処理とログの改善

## 👥 クレジット

- **オリジナル作者**：Ariagle _（元のサイトは運営終了）_
- **メンテナー**：Horlicks (<https://www.moelog.com/>)
- **インスピレーション**：クラシック MP Ukagaka プラグイン / 伺か (Ukagaka)

## 📄 ライセンス

このプラグインはオリジナルの MP Ukagaka プラグインをベースにしています。オリジナルプラグインのライセンス条項を参照してください。

## 🔗 リンク

- [萌えログ.COM](https://www.moelog.com/)
- [Wikipedia - 伺か](http://en.wikipedia.org/wiki/Ukagaka)
- [Google AI Studio](https://makersuite.google.com/app/apikey)（Gemini API Key）
- [OpenAI Platform](https://platform.openai.com/api-keys)（OpenAI API Key）
- [Anthropic Console](https://console.anthropic.com/)（Claude API Key）

## 💬 サポート

問題や提案がありましたら：

- [萌えログ.COM](https://www.moelog.com/)を訪問
- WordPress 管理画面の FAQ セクションを確認
- 上記のトラブルシューティングセクションを参照
- GitHub で Issue を開く

---

**Made with ❤ for WordPress コミュニティ**
